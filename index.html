<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coaster Ranker</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Loading Screen -->
    <div id="imageLoadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <h2>Loading Coaster Images...</h2>
            <div class="roller-coaster-container">
                <svg class="coaster-track" viewBox="0 0 400 80" preserveAspectRatio="none">
                    <!-- Straight track -->
                    <line x1="0" y1="60" x2="400" y2="60" class="track-line" stroke="white" stroke-width="5" stroke-linecap="round" />
                </svg>
                <div id="coasterTrain" class="coaster-train">
                    <div class="train-car"></div>
                    <div class="train-car"></div>
                    <div class="train-car"></div>
                </div>
            </div>
            <p id="loadingProgressText">Preparing images (0/0)</p>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-inner">
                <div class="header-left">
                    <div class="current-user-badge" id="currentUserBadge">Select a user</div>
                </div>

                <div class="header-center">
                    <h1>Coaster Ranker</h1>
                </div>

                <div class="header-right">
                    <button id="userMenuToggle" class="hamburger-btn" aria-haspopup="true" aria-expanded="false" title="Choose user" onclick="toggleUserMenu()">‚ò∞</button>
                    <div id="userMenu" class="user-menu" aria-hidden="true">
                        <button class="user-btn" onclick="switchUser('luca')" id="btn-luca">üë§ Luca</button>
                        <button class="user-btn" onclick="switchUser('wouter')" id="btn-wouter">üë§ Wouter</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('home')">
                <span class="tab-icon"><img src="images/user.svg" alt="Profile" style="width: 1em; height: 1em;"></span>
                <span class="tab-text">Profile</span>
            </button>
            <button class="tab" onclick="switchTab('battle')">
                <span class="tab-icon"><img src="images/sword.svg" alt="Battle" style="width: 1em; height: 1em;"></span>
                <span class="tab-text">Battle</span>
            </button>
            <button class="tab" onclick="switchTab('ranking')">
                <span class="tab-icon"><img src="images/chart-line-up.svg" alt="Ranking" style="width: 1em; height: 1em;"></span>
                <span class="tab-text">Ranking</span>
            </button>
            <button class="tab" onclick="switchTab('history')">
                <span class="tab-icon"><img src="images/scroll.svg" alt="History" style="width: 1em; height: 1em;"></span>
                <span class="tab-text">History</span>
            </button>
            <button class="tab" onclick="switchTab('achievements')">
                <span class="tab-icon"><img src="images/trophy.svg" alt="Achievements" style="width: 1em; height: 1em;"></span>
                <span class="tab-text">Achievements</span>
            </button>
        </div>

        <div id="home-tab" class="tab-content active">
            <div class="home-welcome">
                <h2 id="homeWelcome">Welcome to Coaster Ranker!</h2>
            </div>

            <!-- Profile Stats Card (Full Width) -->
            <div class="home-card home-card-full">
                <div class="stats-summary">
                    <div class="stat-item">
                        <div class="stat-value" id="homeTotalBattles">0</div>
                        <div class="stat-label">Total Battles</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="homeTotalCoasters">0</div>
                        <div class="stat-label">Coasters</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="homeProgressMatchups">0/0</div>
                        <div class="stat-label">Matchups Completed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="homeProgressPercentage">0%</div>
                        <div class="stat-label">Progress</div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Daily Quest + Session Stats -->
            <div class="home-grid">
                <div class="home-card">
                    <h3 class="home-card-title">üéØ Daily Quest</h3>
                    <div class="daily-quest">
                        <p class="quest-description">Complete 25 battles today</p>
                        <div class="quest-progress">
                            <div class="quest-progress-bar">
                                <div class="quest-progress-fill" id="questProgressFill" style="width: 0%"></div>
                            </div>
                            <p class="quest-text" id="questProgressText">0/25 battles</p>
                        </div>
                    </div>
                    <button class="home-action-btn" onclick="switchTab('battle')" style="width: 100%; margin-top: 12px;">‚öîÔ∏è Start Battle!</button>
                </div>

                <div class="home-card">
                    <h3 class="home-card-title">‚ö° Session Stats</h3>
                    <div class="session-stats">
                        <div class="session-stat">
                            <span class="session-stat-value" id="sessionBattles">0</span>
                            <span class="session-stat-label">Battles this session</span>
                        </div>
                        <div class="session-stat">
                            <span class="session-stat-value" id="sessionCloseFights">0</span>
                            <span class="session-stat-label">Close fights</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 3: Top 3 + Achievements -->
            <div class="home-grid">
                <div class="home-card">
                    <h3 class="home-card-title"> Your Top 3</h3>
                    <div class="top-coasters" id="homeTop3">
                        <div class="no-battles">No rankings yet</div>
                    </div>
                    <button class="home-link-btn" onclick="switchTab('ranking')">View Full Ranking ‚Üí</button>
                </div>

                <div class="home-card">
                    <h3 class="home-card-title">üèÖ Achievements</h3>
                    <div class="achievement-summary">
                        <div class="achievement-count">
                            <span class="achievement-count-big" id="homeAchievementCount">0/0</span>
                            <span class="achievement-count-label">Unlocked</span>
                        </div>
                        <div class="recent-achievements" id="homeRecentAchievements">
                            <!-- Recent achievement icons will go here -->
                        </div>
                    </div>
                    <button class="home-link-btn" onclick="switchTab('achievements')">View All ‚Üí</button>
                </div>
            </div>

            <!-- Reset Buttons -->
            <div class="profile-reset-container">
                <button class="profile-reset-btn profile-reset-ranking" onclick="resetRankingOnly()">üîÑ Reset Ranking</button>
                <button class="profile-reset-btn profile-reset-all" onclick="resetAllData()">‚ö†Ô∏è Reset All Data</button>
            </div>
        </div>

        <div id="battle-tab" class="tab-content">
            <div class="battle-area">
            <div class="vs-overlay">VS</div>
            <div class="battle-container" id="battleContainer">
                <div class="no-battles">Select a user above first! üëÜ</div>
            </div>
        
            </div>
        </div>
        <div id="history-tab" class="tab-content">
            <div class="history-header-row">
                <div class="autocomplete-container">
                    <div class="search-input-wrapper">
                        <input id="historySearch" type="text" class="search-box" placeholder="üîç Search matchup..." oninput="handleHistorySearchInput()" onkeydown="handleHistorySearchKeydown(event)" onfocus="showHistoryAutocomplete()" style="width:100%;" />
                        <button id="clearHistorySearchBtn" class="clear-search-btn" onclick="clearHistorySearch()" style="display:none;" title="Clear search">‚úï</button>
                    </div>
                    <div id="historyAutocomplete" class="autocomplete-dropdown"></div>
                </div>
                <!-- History Filters: always visible, but wins/losses only when coaster selected -->
                <div class="history-filters" id="historyFilters" aria-hidden="false">
                    <button class="filter-btn active" data-filter="all" onclick="setHistoryFilter('all')">All battles</button>
                    <button class="filter-btn" data-filter="close" onclick="setHistoryFilter('close')">Close fights</button>
                    <button class="filter-btn coaster-specific" data-filter="wins" onclick="setHistoryFilter('wins')">Wins</button>
                    <button class="filter-btn coaster-specific" data-filter="losses" onclick="setHistoryFilter('losses')">Losses</button>
                </div>
            </div>
            <div id="historyContainer" style="overflow:auto;">
                <div class="no-battles">No battles yet ‚Äî start choosing to build your history.</div>
            </div>
        </div>

        <div id="ranking-tab" class="tab-content">

            <div class="ranking-header">
                <div class="filter-container">
                    <input type="text" class="search-box" id="searchBox" placeholder="üîç Search coaster, park or manufacturer..." onkeyup="filterRanking()">
                </div>
                <div class="ranking-stats-minimal">
                    <span class="ranking-info-box"><span id="rankingTotalCoasters">0</span> Coasters</span>
                    <span class="ranking-info-box"><span id="rankingProgressMatchups">0/0</span> Matchups</span>
                </div>
                <button class="download-btn" onclick="downloadRankingCSV()">üì• Download Ranking</button>
            </div>

            <table class="ranking-table" id="rankingTable">
                <thead>
                    <tr>
                        <th onclick="sortRanking('rank')">Rank</th>
                        <th onclick="sortRanking('name')">Name</th>
                        <th onclick="sortRanking('park')">Park</th>
                        <th onclick="sortRanking('manufacturer')">Manufacturer</th>
                        <th onclick="sortRanking('rating')">Rating</th>
                        <th onclick="sortRanking('battles')">Battles</th>
                        <th onclick="sortRanking('wins')">Wins</th>
                        <th onclick="sortRanking('losses')">Losses</th>
                    </tr>
                </thead>
                <tbody id="rankingBody">
                    <tr><td colspan="8" class="no-battles">Select a user first! üé¢</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Achievements Tab -->
        <div id="achievements-tab" class="tab-content">
            <div class="achievement-filters">
                <div class="achievement-counter" id="achievementFilterCounter">0/31 unlocked</div>
                <div class="filter-tags-container">
                    <button class="filter-tag active" data-category="all" onclick="filterAchievements('all')">
                        All
                    </button>
                    <button class="filter-tag" data-category="battles" onclick="filterAchievements('battles')">
                        ‚öîÔ∏è Battles
                    </button>
                    <button class="filter-tag" data-category="close-fights" onclick="filterAchievements('close-fights')">
                        üí• Close Fights
                    </button>
                    <button class="filter-tag" data-category="patterns" onclick="filterAchievements('patterns')">
                        üîÑ Patterns
                    </button>
                    <button class="filter-tag" data-category="collection" onclick="filterAchievements('collection')">
                        üåç Collection
                    </button>
                    <button class="filter-tag" data-category="siblings" onclick="filterAchievements('siblings')">
                        üëØ Siblings
                    </button>
                    <button class="filter-tag" data-category="ranking" onclick="filterAchievements('ranking')">
                        üìä Ranking
                    </button>
                    <button class="filter-tag" data-category="special" onclick="filterAchievements('special')">
                        ‚ú® Special
                    </button>
                </div>
            </div>
            <div class="achievements-grid" id="achievementsGrid">
                <!-- Achievement cards will be inserted here dynamically -->
            </div>
        </div>
    </div>

    <!-- Developer button (bottom-left) -->
    <button id="devToggleBtn" class="dev-toggle dev-btn" aria-haspopup="true" aria-expanded="false" title="Developer options" onclick="toggleDevMenu()">
        <svg class="icon icon-gear" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" focusable="false">
            <path d="M12 15.5A3.5 3.5 0 1 0 12 8.5a3.5 3.5 0 0 0 0 7zm8.2-3a6.7 6.7 0 0 0-.1-1l2.1-1.6-2-3.4-2.5.6a7 7 0 0 0-1.6-.9L15 2h-6l-.6 2.2c-.5.2-1 .5-1.6.9L4.3 4.5 2.3 7.9l2.1 1.6c-.1.3-.1.6-.1 1s0 .7.1 1L2.3 15.1 4.3 18.5l2.5-.6c.5.4 1.1.7 1.6.9L9 22h6l.6-2.2c.5-.2 1-.5 1.6-.9l2.5.6 2-3.4-2.1-1.6c.1-.3.1-.6.1-1z"/>
        </svg>
    </button>
    <div id="devMenu" class="dev-menu" aria-hidden="true" role="dialog" aria-label="Developer options">
        <div class="dev-menu-header">Developer Options</div>
        <div class="dev-menu-body">
            <div class="dev-option">
                <div style="display:flex;gap:8px;align-items:center;">
                    <input id="simulateCount" class="sim-input" type="number" min="1" value="100" />
                    <button id="simulateBtn" class="simulate-btn dev-btn" onclick="simulateBattlesFromUI()">Simulate</button>
                </div>
                <div id="simulateProgress" class="dev-progress" aria-hidden="true" style="display:none;margin-top:8px;font-size:0.9em;color:#4CA1AF;"></div>
            </div>

            <div class="dev-option" style="margin-top:12px;">
                <button id="devToggleDataBtn" class="dev-btn dev-toggle-data" onclick="toggleDevData()" aria-pressed="false">Show dev-data</button>
                
            </div>

            <div class="dev-option" style="margin-top:12px;">
                <div style="font-size:0.9em;color:#6B7280;margin-bottom:6px;font-weight:600;">Image Loading</div>
                <div id="imageLoadProgress" class="dev-progress" style="font-size:0.85em;color:#4CA1AF;font-weight:700;">
                    Loaded: 0 / 0 (0%)
                </div>
                <div id="imageLoadDetails" style="font-size:0.8em;color:#9CA3AF;margin-top:4px;">
                    Cache hits: 0 | Errors: 0
                </div>
                <button class="dev-btn" onclick="clearImageCache()" style="margin-top:8px;width:100%;background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:white;">
                    Clear Image Cache
                </button>
            </div>

            <div class="dev-option" style="margin-top:8px;">
                <button id="forceCloseBtn" class="dev-btn" onclick="forceNextCloseFight()" title="Force a close fight">Force close fight</button>
            </div>

            <div class="dev-option" style="margin-top:12px;border-top:1px solid #ddd;padding-top:12px;">
                <div style="font-size:0.9em;font-weight:700;margin-bottom:12px;color:#111827;">Pairing Parameters</div>
                
                <div style="margin-bottom:12px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <label style="font-size:0.85em;color:#666;">Exploration Power</label>
                        <span id="explorationPowerValue" style="min-width:36px;text-align:center;font-weight:700;color:#2c3e50;font-size:0.9em;">2.0</span>
                    </div>
                    <input id="explorationPowerRange" type="range" min="0" max="5" step="0.1" value="2.0" oninput="setExplorationPower(this.value)" style="width:100%;">
                    <div style="font-size:0.75em;color:#888;margin-top:2px;">Higher = favor under-sampled coasters more</div>
                </div>

                <div>
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                        <label style="font-size:0.85em;color:#666;">Rating Proximity Power</label>
                        <span id="eloProximityValue" style="min-width:36px;text-align:center;font-weight:700;color:#2c3e50;font-size:0.9em;">0.1</span>
                    </div>
                    <input id="eloProximityRange" type="range" min="0" max="4" step="0.1" value="0.1" oninput="setEloProximityPower(this.value)" style="width:100%;">
                    <div style="font-size:0.75em;color:#888;margin-top:2px;">Higher = prefer opponents with similar rating</div>
                </div>
            </div>

            <div class="dev-option" style="margin-top:12px;border-top:1px solid #ddd;padding-top:12px;">
                <button id="rankingWizardBtn" class="dev-btn" onclick="runRankingWizard()" title="Recalculate all battles with current Glicko-2 settings">Ranking Wizard</button>
                <div id="rankingWizardProgress" class="dev-progress" style="display:none;margin-top:8px;font-size:0.9em;color:#4CA1AF;"></div>
            </div>

            <div class="dev-option" style="margin-top:12px;">
                <button class="reset-btn dev-reset-btn dev-btn" onclick="resetAllUserData()">Reset user data</button>
            </div>

            <div class="dev-option" style="margin-top:12px; display: flex; gap: 8px;">
                <button class="dev-btn" onclick="exportUserData()" style="flex: 1; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                    Export User Data
                </button>
                <button class="dev-btn" onclick="document.getElementById('importFileInput').click()" style="flex: 1; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                    Import User Data
                </button>
            </div>
            <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importUserData(event)" />
        </div>
    </div>

    <!-- Close-battle full-screen overlay (visuals only; pointer-events:none so UI stays clickable) -->
    <div id="closeBattleOverlay" class="close-battle-overlay" aria-hidden="true" style="display: none; opacity: 0;">
        <div class="arena-lights"></div>
        <div class="arena-center">
            <div class="coaster-side" id="cLeft">
                <div class="coaster-name" id="cLeftName"></div>
            </div>
            <div class="coaster-side" id="cRight">
                <div class="coaster-name" id="cRightName"></div>
            </div>
        </div>

        <div class="winner-burst" id="winnerBurst" aria-hidden="true">
            <div class="winner-text" id="winnerText">Winner!</div>
        </div>
        <div class="close-banner" id="closeBanner" aria-hidden="true">CLOSE FIGHT</div>
    </div>

    <!-- Reset All Data Modal -->
    <div id="resetModal" class="custom-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ö†Ô∏è Reset All Data</h2>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reset <strong>all</strong> data for <span id="resetUserName"></span>?</p>
                <p class="modal-warning">This will permanently delete:</p>
                <ul class="modal-list">
                    <li>All battle history</li>
                    <li>All coaster rankings</li>
                    <li>All achievements</li>
                    <li>All progress and statistics</li>
                </ul>
                <p class="modal-warning-strong">This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeResetModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm" onclick="confirmReset()">Reset Everything</button>
            </div>
        </div>
    </div>

    <!-- Reset Ranking Only Modal -->
    <div id="resetRankingModal" class="custom-modal">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header modal-header-warning">
                <h2>üîÑ Reset Ranking</h2>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to reset the ranking for <span id="resetRankingUserName"></span>?</p>
                <p class="modal-warning">This will permanently delete:</p>
                <ul class="modal-list">
                    <li>All battle history</li>
                    <li>All coaster rankings</li>
                </ul>
                <p class="modal-info">Your achievements and daily progress will be preserved.</p>
                <p class="modal-warning-strong">This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-cancel" onclick="closeResetRankingModal()">Cancel</button>
                <button class="modal-btn modal-btn-confirm-warning" onclick="confirmResetRanking()">Reset Ranking</button>
            </div>
        </div>
    </div>

    <script src="achievements.js"></script>
    <script src="script.js"></script>
</body></html>
